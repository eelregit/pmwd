\documentclass[usenatbib]{mnras}

% Allow "Thomas van Noord" and "Simon de Laguarde" and alike to be sorted by "N" and "L" etc. in the bibliography.
% Write the name in the bibliography as "\VAN{Noord}{Van}{van} Noord, Thomas"
\DeclareRobustCommand{\VAN}[3]{#2}
\let\VANthebibliography\thebibliography
\def\thebibliography{\DeclareRobustCommand{\VAN}[3]{##3}\VANthebibliography}


\usepackage{microtype}
\usepackage{newpxtext, eulerpx}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{bm}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{nicefrac}


\newcommand{\pmwd}{{\usefont{T1}{nova}{m}{sl}pmwd}}

\renewcommand{\sectionautorefname}{Sec.}
\renewcommand{\subsectionautorefname}{Sec.}
\renewcommand{\appendixautorefname}{App.}
\renewcommand{\figureautorefname}{Fig.}
%\newcommand{\subfigureautorefname}{\figureautorefname}

%FIXME copied from ../adjoint/adjoint.tex
\newcommand{\deltaD}{\delta^\textsc{d}}
\newcommand{\deltaK}{\delta^\textsc{k}}
\renewcommand{\d}{d}
\newcommand{\p}{\partial}
\newcommand{\cJ}{\mathcal{J}}
\newcommand{\cR}{\mathcal{R}}
\newcommand{\cL}{\mathcal{L}}
\newcommand{\cH}{\mathcal{H}}
\bmdefine{\vzero}{0}
\bmdefine{\vI}{I}
\bmdefine{\vnabla}{\nabla}
\bmdefine{\vtheta}{\theta}  % parameters
\bmdefine{\vvartheta}{\vartheta}  % relevant scales and factors to form
                                  % dimensionless features as NN inputs
\bmdefine{\vomega}{\omega}  % white noise modes
\bmdefine{\vk}{k}  % wavevectors
\bmdefine{\vx}{x}  % comoving and canonical coordinates
\bmdefine{\vq}{q}  % Lagrangian coordinates
\bmdefine{\vs}{s}  % displacements
\bmdefine{\vp}{p}  % canonical momenta
\bmdefine{\vv}{v}  % FIXME some velocities
\bmdefine{\va}{a}  % accelerations
\bmdefine{\vz}{z}  % states
\bmdefine{\vo}{o}  % observable
\bmdefine{\vf}{f}
\bmdefine{\vF}{F}
\bmdefine{\vDelta}{\Delta}
\bmdefine{\vLambda}{\Lambda}
\bmdefine{\vlambda}{\lambda}
\bmdefine{\vvarphi}{\varphi}
\bmdefine{\vxi}{\xi}  % x adjoint
\bmdefine{\vpi}{\pi}  % p adjoint
\bmdefine{\valpha}{\alpha}  % force vjp x gradient
\bmdefine{\vzeta}{\zeta}  % force vjp theta gradient
\newcommand{\half}{\nicefrac12}
\newcommand{\As}{A_\mathrm{s}}
\newcommand{\ns}{n_\mathrm{s}}
\newcommand{\Omegam}{\Omega_\mathrm{m}}
\newcommand{\Omegab}{\Omega_\mathrm{b}}
\newcommand{\Mpc}{\mathrm{Mpc}}
\newcommand{\ic}{\mathrm{i}}
\newcommand{\linear}{\mathrm{lin}}
\newcommand{\tophat}{\mathrm{TH}}
\newcommand{\gauss}{\mathrm{G}}

\newcommand{\YL}[1]{\textcolor{Bittersweet}{#1}}



\title[Spatiotemporally Optimized Simulation]
{Spatiotemporal Optimization of Cosmological Particel-Mesh Simulation}


\author[Zhang, Li, Jamieson, et al.]{
%
Yucheng Zhang,$^{1, 2}$
%
Yin Li,$^{1, 3}$\thanks{Email: XYZ, eelregit@gmail.com, and XYZ}
%
and Drew Jamieson$^{4}$
%
\\$^1$Department of Mathematics and Theory, Peng Cheng Laboratory,
Shenzhen, Guangdong 518066, China
%
\\$^2$Center for Cosmology and Particle Physics, Department of Physics,
New York University, New York, NY 10003, USA
%
\\$^3$Center for Computational Astrophysics \& Center for Computational
Mathematics, Flatiron Institute, New York, NY 10010, USA
%
\\$^4$Max Planck Institute for Astrophysics, 85748 Garching bei
M\"unchen, Germany
}


\date{Accepted XXX. Received YYY; in original form ZZZ}
\pubyear{2023}



\begin{document}
\label{firstpage}
\pagerange{\pageref{firstpage}--\pageref{lastpage}}
\maketitle



\begin{abstract}
We sharpen PM force and optimize integration time steps.
\end{abstract}

\begin{keywords}
cosmology: large-scale structure of Universe
-- methods: numerical
-- software: development
\end{keywords}



\section{Introduction}


\section{Methods}


\subsection{Simulation and Differentiation}

We briefly recap the discussion in \citet{Li2022a} and introduce the notations.
We denote the particles' state with $\vz = (\vx, \vp)^\intercal$ and their
adjoint variables with $\vlambda = (\vxi, \vpi)$.
The forward simulation is evolved using a symplectic integrator.
From $a_{i-1}$ to $a_i$, the particles' state is updated alternately for $\vx$
and $\vp$ through a loop over the symplectic integration indexed with $j$
\begin{alignat}{2}
&D_{j-1}^j: &\qquad \vx_j &= \vx_{j-1} +
  \vp_{j-1} D(a^p_{j-1}, a^x_{j-1}, a^x_j), \nonumber\\
%
&F_j: & \va_j &\triangleq -\vnabla\varphi(\vx_j), \nonumber\\
%
&K_{j-1}^j: & \vp_j &= \vp_{j-1} + \va_j K(a^x_j, a^p_{j-1}, a^p_j).
\label{DFK}
\end{alignat}
The intermediate times are given by
\begin{align}
a^x_j &= (1 - C^x_j) a_{i-1} + C^x_j a_i, \nonumber\\
a^p_j &= (1 - C^p_j) a_{i-1} + C^p_j a_i,
\end{align}
where $C^x$ and $C^p$ are the cumulative coefficients of the symplectic
integrator, e.g. $C^x = (0, 0, 1)$ and $C^p = (0, 0.5, 1)$ for leapfrog.
The reverse time integration from $a_i$ to $a_{i-1}$ and adjoint equations
\begin{alignat}{2}
&K_j^{j-1}: &\qquad \vp_{j-1} &= \vp_j +
  \va_j K(a^x_j, a^p_j, a^p_{j-1}), \nonumber\\
%
& & \vxi_{j-1} &= \vxi_j - \valpha_j K(a^x_j, a^p_j, a^p_{j-1}) \nonumber\\
%
&D_j^{j-1}: & \vx_{j-1} &= \vx_j +
  \vp_{j-1} D(a^p_{j-1}, a^x_j, a^x_{j-1}), \nonumber\\
%
& & \vpi_{j-1} &= \vpi_j - \vxi_{j-1} D(a^p_{j-1}, a^x_j, a^x_{j-1}), \nonumber\\
%
&F_{j-1}: & \va_{j-1} &\triangleq -\vnabla\vvarphi(\vx_{j-1}), \nonumber\\
%
& & \valpha_{j-1} &\triangleq -\vpi_{j-1} \cdot
  \frac{\p\vnabla\vvarphi_{j-1}}{\p\vx_{j-1}}, \nonumber\\
& & \vzeta_{j-1} &\triangleq - \vpi_{j-1} \cdot
  \frac{\p\vnabla\vvarphi_{j-1}}{\p\vtheta}.
\label{KDF_adj}
\end{alignat}

We consider an objective function $\cJ(\vo, \theta)$ defined on the observable
$\vo(\vz_0,...,\vz_n,\vtheta)$.
The observe operator from $a_i$ to $a_{i-1}$ reads
\begin{align}
  O_i^{i-1}: \qquad \vxi_{i-1} :\:\!\!\!&= \vxi_{i-1}
  + \frac{\p\cJ}{\p\vo} \cdot \frac{\p\vo}{\p\vx_{i-1}}, \nonumber\\
                    \vpi_{i-1} :\:\!\!\!&= \vpi_{i-1}
  + \frac{\p\cJ}{\p\vo} \cdot \frac{\p\vo}{\p\vp_{i-1}}.
\end{align}

% % TODO update the final gradient for loop over j
% The final gradient is accumulated through
% \begin{multline}
%   \frac{\d\cJ}{\d\vtheta} = \frac{\p\cJ}{\p\vtheta}
%   %
%   + \frac{\p\cJ}{\p\vo} \cdot \frac{\p\vo}{\p\vtheta}
%   %
%   + \vxi_0 \cdot \frac{\p\vx_0}{\p\vtheta}
%   + \vpi_0 \cdot \frac{\p\vp_0}{\p\vtheta} \\
%   %
%   - \sum_{i=1}^n \Bigl[
%     \bigl( \vpi_i \cdot\va_i \frac\p{\p\vtheta} + \vzeta_i
%       \bigr) K(t_i, t_i, t_{i-\half}) \\
%     + \vxi_i \cdot \vp_{i-\half}
%       \frac{\p D(t_{i-\half}, t_i, t_{i-1})}{\p\vtheta}
%     \Bigr],
% \label{KDFO_grad}
% \end{multline}
% where $\vtheta$ could include cosmological parameters, initial conditions, as
% well as STO parameters in this work.


\subsection{Snapshot Observable}

Given two snapshots at $a_i$ and $a_{i+1}$, we get the particle displacements
in between at $a$ using interpolation with the cubic Hermite spline,
\begin{align}
  \vx(a) =\ &h_{00}(\alpha)\vx_i + h_{10}(\alpha)(a_{i+1} - a_i)\vv_i + \nonumber\\
           &h_{01}(\alpha)\vx_{i+1} + h_{11}(\alpha)(a_{i+1} - a_i)\vv_{i+1},
\end{align}
where $\alpha := (a - a_i)/(a_{i+1} - a_i)$ and the Hermite basis functions read
\begin{align}
  h_{00}(\alpha) &= 2\alpha^3 - 3\alpha^2 + 1, \nonumber\\
  h_{10}(\alpha) &= \alpha^3 - 2\alpha^2 + \alpha, \nonumber\\
  h_{01}(\alpha) &= -2\alpha^3 + 3\alpha^2, \nonumber\\
  h_{11}(\alpha) &= \alpha^3 - \alpha^2.
\end{align}
The particle velocity is then given by the derivative $\d\vx / \d a$.

Our observable $\vo$ is a snapshot $\hat\vz = (\hat\vx, \hat\vp)^\intercal$ at a
given time $a_o$, which in general can be given by the interpolation of two
snapshots $\vz_{k-1}$ and $\vz_k$ where $a_{k-1} \leq a_o < a_k$.
Then ${\p\vo}/{\p\vz_i}$ would be zero except for the relevant $\vz_{k-1}$ and
$\vz_k$.
We have in the initial conditions of the adjoint equations
\begin{align}
  \vxi_n &= \frac{\p\cJ}{\p\vo} \cdot \frac{\p\vo}{\p\vx_n}, \nonumber\\
  \vpi_n &= \frac{\p\cJ}{\p\vo} \cdot \frac{\p\vo}{\p\vp_n}.
\end{align}
In the reverse time evolution of the adjoint equations, these adjoint varibales
remain zero until the time stepping from $a_{k+1}$ to $a_k$.


\subsection{Objective Function}

Again combine Lagrangian and Eulerian fields.

A mean squared error (MSE) loss on the fields would focus too much on
the small scales. In this work we choose uniform weights in the scale
space, by weighing each mode of wavenumber $k$ by $k^{-3}$ in the MSE
loss
\begin{equation}
  \cJ = \mathbb{E} \sum_\vk k^{-3}
    \bigl| \hat f(\vk) - f(\vk) \bigr|^2.
\end{equation}

An alternative loss function can be the Eulernian density weighted
particle displacement MSE.



\subsection{Spatial Optimization}

The dimensionless power spectrum
%
\begin{equation}
\Delta^2(k) \triangleq \frac{k^3 P(k)}{2 \pi^2}.
\end{equation}

Variance of linear matter overdensity in a top-hat window
%
\begin{equation}
\sigma_\tophat^2(R) = \int_0^\infty \frac{\d k}k
  \Delta_\linear^2(k) W_\tophat^2(kR),
\end{equation}
where $W_\tophat(kR) = 3[\sin(kR) - kR\cos(kR)] / (kR)^3$ is the
Fourier transform of the top-hat window.
Likewise $\sigma_\gauss^2(R)$ is defined with a Gaussian window
$W_\gauss(kR) = e^{-(kR)^2/2}$.


Various nonlinear scales are
\begin{itemize}
\item $k_P^{-1}$: determined by $\Delta_\linear^2(k_P) \triangleq 1$;
\item $R_\tophat$: determined by $\sigma_\tophat^2(R_\tophat) \triangleq
  1$;
\item $R_\gauss$: determined by $\sigma_\gauss^2(R_\tophat) \triangleq
  1$;
\item $R_\mathrm{d}$: rms linear theory displacement;
\item $\d R / \d\ln a$: time derivatives of the above scales.
\end{itemize}

Other relevant scales are
\begin{itemize}
\item $l_\mathrm{cell}$: PM cell size.
\item particle spacing;
\item softening length.
\end{itemize}

Relevant scale-independent dimensionless factors are
\begin{itemize}
\item $D(a)$: linear growth factor;
\item $f(a)$: linear growth rate $f \triangleq \d\ln D / \d\ln a$;
\item $\Omegam(a)$: matter density parameter at $a$;
\item $\d\ln H / \d\ln a$: time derivative of Hubble expansion;
\item $a$: scale factor;
\item $\Delta a$: time step size in $a$.
\end{itemize}

We combine the above list of parameters in $\vvartheta$.


Force sharpening
%
\begin{equation}
\frac{k_i}{k^2} \to \frac{k_i}{k^2}
  h(k_i; \vvartheta) g(k; \vvartheta) \prod_{j=1}^3 f(k_j; \vvartheta),
\end{equation}
%
where $f$, $g$, $h$ are neural networks, each approximating a nonlinear
function of the dimensionless features, e.g.,
%
\begin{equation}
g(k; \vvartheta) = g(k/k_P, kR_\tophat, \cdots; D, f, \cdots).
\end{equation}


\subsection{Temporal Optimization}

We use a spline to model the function $a(t)$ that maps uniformly sampled $t$
values to optimally distributed $a$ time steps.
The spline is parameterized with a number of control points that are updated
during training.
The gradients (i.e. cotangents) are back propagated from an array of integration
time steps to the control points through a VJP transformation of $a(t)$.



\begin{table*}
\centering
\caption{Ranges of GADGET-4 and \pmwd\ configuration and cosmological
parameters.
Note that the grid ratio need next fast len to determine the mesh shape
for fast FFT.
Given the box size, the mesh shape determines the cell size.
The softening parameter gives the ratio of the comving softening length
to the mean particle spacing.
The curvature $\Omega_k$ is related to the separate universe simulation.
We sample parameters applicable to GADGET-4 during data generation, and
those applicable to \pmwd\ during training.
\textsuperscript\dag The box size is determined jointly by the \pmwd\
mesh shape and mesh cell size below, which are assumed to be sampled
independently.
In practice, we sample one conditioned on the other and the box size.
* Number of time steps from $a=1/16$ to $a=1$.
}
\label{tab:param}
\begin{tabular}{lcccr}
  \toprule
  applicability & parameter & distribution & range & sampling \\
  \midrule
  & $128^3$ white noise & $\mathcal{N}(\vzero, \vI)$ & 512 realizations & MC \\
  \cmidrule(lr){2-5}
  & 121 snapshots, $a$ & uniform & [1/16, 1] & deterministic \\
  \cmidrule(lr){2-5}
  & box size in Mpc\textsuperscript\dag & log-trapezoidal & [25.6, 2560) \\
  \cmidrule(lr){2-4}
  & snapshot offset, $\Delta\!a$ & uniform & [0, 1/128) \\
  \cmidrule(lr){2-4}
  GADGET-4 & $\As \times 10^9$ & log-uniform & [1, 4) \\
  \cmidrule(lr){2-4}
  \& \pmwd\ & $\ns$ & log-uniform & [0.75, 1.25) & RQMC \\
  \cmidrule(lr){2-4}
  & $\Omegam$ & log-uniform & [1/5, 1/2) & see \autoref{fig:sobol} \\
  \cmidrule(lr){2-4}
  & $\Omegab / \Omegam$ & log-uniform & [1/16, 1/2) \\
  \cmidrule(lr){2-4}
  & $\Omega_k / (1 - \Omega_k)$ & uniform & [-0.5, 0.5) \\
  \cmidrule(lr){2-4}
  & $h$ & log-uniform & [0.5, 1) \\
  \cmidrule(lr){1-4}
  GADGET-4 & softening ratio & log-uniform & [1/50, 1/20) \\
  \cmidrule(lr){1-5}
  & mesh shape & log-uniform & [128, 512] \\
  \cmidrule(lr){2-4}
  \pmwd\ & mesh cell size in Mpc & log-uniform & [0.2, 5] & MC \\
  \cmidrule(lr){2-4}
  & number of time steps* & log-uniform & [10, 1000] \\
  \bottomrule
\end{tabular}
\end{table*}


\subsection{Parameters and Configurations}

We run 512 GADGET-4 simulations that cover a wide range of
configurations and cosmological parameters, as listed in
\autoref{tab:param}.
Each simulation has $128^3$ particles and writes 121 snapshots linearly
spaced in scale factor from $1/16 + \Delta a$ to $1 + \Delta a$, with
spacing $1/128$.
$\Delta a$ is an offset, common for all snapshots in each simulation,
that varies as in \autoref{tab:param} and helps to sample different
alignment between snapshot and start/stop times.

The curvature $\Omega_k$ is related to the separate universe simulation
\citep{LiEtAl2014a, WagnerEtAl2015}.


\begin{figure*}
  \centering
  \includegraphics[width=0.9\linewidth]{sobol.pdf}
  \caption{Randomized Quasi-Monte Carlo (RQMC) configuration with
    scrambled Sobol sequence of 512 points in 9D.
    Lower triangular panels show the 2D projections and the diagonal
    panels are the 1D cumulative histograms.
    From left to right (top to bottom), we use each dimension of the
    sample to scale the parameters as ordered in \autoref{tab:param}.
    We use the \texttt{scipy.stats.qmc} package \citep{SciPy} to
    generate the Sobol sequence \citep{Sobol1967}, which uses the
    direction number from \citet{JoeKuo2008} and the Owen scrambling
    \citep{Owen1998}.
    We search among 65536 scrambling seeds to minimize the mixture
    discrepancy (a uniformity measure) proposed in \citet{Zhou2013MD}.
  }
  \label{fig:sobol}
\end{figure*}

\begin{figure*}
  \centering
  %\includegraphics[width=0.8\linewidth]{name.ext}
  \caption{1D histogram of the parameters sampled with RQMC and scaled
  as in \autoref{tab:param}}.
  \label{fig:hist}
\end{figure*}


\subsection{Simulations}

\citet{GADGET-4}

We configure GADGET-4 with high force and time integration accuracy
settings.
For gravitational force, we choose pure FMM with $p=5$ and opening angle
0.4.
%FIXME list other from Config.sh and param.txt


\section{Results}


\section{Conclusions}


\section*{Acknowledgements}

The Flatiron Institute is supported by the Simons Foundation.


\section*{Code Availability}

\pmwd\ \citep{Li2022b} is open-source on
\href{https://github.com/eelregit/pmwd}{GitHub}, including the
\href{https://github.com/eelregit/pmwd/tree/master/docs/papers/sto}{source
and scripts of this paper}.



\bibliographystyle{mnras}
\bibliography{sto}



\bsp  % typesetting comment
\label{lastpage}
\end{document}
